name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      reset_db:
        description: "DANGER: reset MySQL container + data (true/false)"
        required: false
        default: "true"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Build with Gradle
        working-directory: ./hangsha
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./hangsha
          file: ./hangsha/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/campus-calendar-server:latest

      - name: Deploy to EC2 (debug)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_KEY }}
          port: 22
          timeout: 30s
          command_timeout: 40m
          script: |
            set -euo pipefail

            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            export DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
            PROJECT="campus"
            NET="${PROJECT}_default"

            # ==== DB settings (from repo docker-compose/application.yml) ====
            DB_NAME="campus_db"
            DB_USER="user"
            DB_PASS="password"
            DB_ROOT_PASS="root"
            DB_CONTAINER_NAME="campus-mysql"
            # ===============================================================

            docker network inspect "$NET" >/dev/null 2>&1 || docker network create "$NET"

            # workflow_dispatch input; default false on push
            RESET_DB=true
            if [ -z "${RESET_DB:-}" ]; then RESET_DB="false"; fi
            echo "RESET_DB=$RESET_DB"

            # ===== helper: find DB containers (campus-mysql or *_campus-mysql) =====
            find_db_containers() {
              docker ps -a --format '{{.Names}}' | grep -E '(^campus-mysql$|_campus-mysql$)' || true
            }

            # ===== DANGER: reset DB (container + volumes/bind data) =====
            if [ "$RESET_DB" = "true" ]; then
              echo "!!! RESETTING DB (container + data) !!!"

              # Stop app first
              docker rm -f campus-server 2>/dev/null || true
              docker ps -a --filter "name=_campus-server" -q | xargs -r docker rm -f

              DBS="$(find_db_containers)"
              if [ -n "$DBS" ]; then
                echo "$DBS" | while read -r c; do
                  [ -z "$c" ] && continue
                  echo "Resetting DB container: $c"

                  # Remove named volumes + delete bind source for /var/lib/mysql
                  # 1) named volumes
                  VOLS="$(docker inspect -f '{{range .Mounts}}{{if and (eq .Type "volume") (eq .Destination "/var/lib/mysql")}}{{.Name}}{{"\n"}}{{end}}{{end}}' "$c" 2>/dev/null || true)"
                  # 2) bind mount source (host path)
                  BINDS="$(docker inspect -f '{{range .Mounts}}{{if and (eq .Type "bind") (eq .Destination "/var/lib/mysql")}}{{.Source}}{{"\n"}}{{end}}{{end}}' "$c" 2>/dev/null || true)"

                  docker rm -f "$c" >/dev/null 2>&1 || true

                  echo "$VOLS" | sed '/^\s*$/d' | while read -r v; do
                    echo "Removing volume: $v"
                    docker volume rm -f "$v" >/dev/null 2>&1 || true
                  done

                  echo "$BINDS" | sed '/^\s*$/d' | while read -r p; do
                    echo "Removing bind data dir: $p"
                    sudo rm -rf "$p" || true
                  done
                done
              else
                echo "No existing DB container found. Creating a new one."
              fi

              # Create fresh MySQL container (matches repo docker-compose settings)
              docker run -d \
                --name "$DB_CONTAINER_NAME" \
                --network "$NET" \
                --restart always \
                -e MYSQL_DATABASE="$DB_NAME" \
                -e MYSQL_ROOT_PASSWORD="$DB_ROOT_PASS" \
                -e MYSQL_USER="$DB_USER" \
                -e MYSQL_PASSWORD="$DB_PASS" \
                mysql:8.0 \
                --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

              # Wait until MySQL is ready (up to 90s)
              echo "Waiting for MySQL to be ready..."
              for i in $(seq 1 90); do
                if docker exec "$DB_CONTAINER_NAME" mysqladmin ping -uroot -p"$DB_ROOT_PASS" --silent 2>/dev/null; then
                  echo "MySQL is ready."
                  break
                fi
                sleep 1
              done

              docker network connect --alias db "$NET" "$DB_CONTAINER_NAME" >/dev/null 2>&1 || true
            fi
            # ===== end reset =====

            # Ensure DB container exists and is connected with alias db
            DB_CONTAINER="$(find_db_containers | head -n1 || true)"
            if [ -z "$DB_CONTAINER" ]; then
              echo "ERROR: No DB container found."; docker ps -a; exit 1
            fi

            docker start "$DB_CONTAINER" >/dev/null 2>&1 || true
            docker network disconnect "$NET" "$DB_CONTAINER" >/dev/null 2>&1 || true
            docker network connect --alias db "$NET" "$DB_CONTAINER" >/dev/null 2>&1 || true

            # Safety: if NOT resetting, detect old Flyway version 9 applied (common cause of boot failure)
            if [ "$RESET_DB" != "true" ]; then
              echo "Checking Flyway history (non-reset deploy)..."
              set +e
              HAS_V9="$(docker exec "$DB_CONTAINER" sh -lc "mysql -u\"$DB_USER\" -p\"$DB_PASS\" -D\"$DB_NAME\" -N -e \"SELECT 1 FROM flyway_schema_history WHERE version='9' LIMIT 1;\" 2>/dev/null" )"
              set -e
              if [ "$HAS_V9" = "1" ]; then
                echo "ERROR: flyway_schema_history has version=9 already applied. This often breaks if V9 migration file is missing in the app image."
                echo "Run this workflow manually with workflow_dispatch input reset_db=true to wipe DB, or restore the V9 migration file in the repo."
                exit 1
              fi
            fi

            docker rm -f campus-server 2>/dev/null || true
            docker ps -a --filter "name=_campus-server" -q | xargs -r docker rm -f

            cat > docker-compose.prod.yml <<EOF
            version: '3.8'
            services:
              app:
                image: ${DOCKER_USERNAME}/campus-calendar-server:latest
                container_name: campus-server
                ports:
                  - "8080:8080"
                environment:
                  SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/${DB_NAME}?serverTimezone=Asia/Seoul&characterEncoding=UTF-8
                  SPRING_DATASOURCE_USERNAME: ${DB_USER}
                  SPRING_DATASOURCE_PASSWORD: ${DB_PASS}
                networks:
                  - ${NET}
                restart: always
            networks:
              ${NET}:
                external: true
            EOF

            COMPOSE="docker compose -p ${PROJECT} -f docker-compose.prod.yml"
            $COMPOSE pull app
            $COMPOSE up -d --no-deps app

            echo "=== ps ==="
            docker ps --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'

            echo "=== app state ==="
            docker inspect -f 'status={{.State.Status}} restarting={{.State.Restarting}} restartCount={{.RestartCount}} exit={{.State.ExitCode}} startedAt={{.State.StartedAt}}' campus-server || true

            echo "=== docker logs (tail 400) ==="
            docker logs --tail 400 campus-server || true

            echo "=== inside container: ps/net/health ==="
            docker exec campus-server sh -lc '
              set -x
              ps aux || true
              (ss -lntp || netstat -lntp) 2>/dev/null || true
              env | grep -E "SPRING_|JAVA|SERVER" || true
              (wget -qS -O- http://127.0.0.1:8080/ 2>&1 | head -n 20) || true
              (wget -qS -O- http://127.0.0.1:8080/api/v1/health 2>&1 | head -n 50) || true
            ' || true

            echo "=== host curl ==="
            curl -sS -D- http://127.0.0.1:8080/api/v1/health || true

            echo "=== wait 120s then curl ==="
            sleep 120
            docker logs --tail 400 campus-server || true
            docker exec campus-server sh -lc 'wget -qS -O- http://127.0.0.1:8080/api/v1/health 2>&1 | head -n 80 || true' || true
            curl -fsS http://127.0.0.1:8080/api/v1/health >/dev/null
